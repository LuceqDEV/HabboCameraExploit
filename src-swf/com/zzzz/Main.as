package com.zzzz 
{
	import com.zzzz.data.DataClient;
	import com.zzzz.data.DataHabbo;
	import com.zzzz.data.DataSettings;
	import flash.utils.getTimer;
	import flash.utils.ByteArray;
    import flash.display.Sprite;
    import flash.system.Security;
	import flash.system.Worker;
	import flash.system.WorkerDomain;
    import flash.events.Event;
	
	public class Main extends Sprite
	{
		public function Main() 
		{
CONFIG::debug
{
			Logging.debug("=========================================================");
			Logging.debug("Loading swf.");
			Logging.debug("- PageDomain " + Security.pageDomain);
			Logging.debug("- SandboxType " + Security.sandboxType);
}
			
			// Results.
			var collector:Collector = new Collector();
			
			// Parse client first, we use this to check if authenticated.
			parseClient(collector, function (): void {
				// Success.
CONFIG::debug
{
				Logging.debug("Client success, continue.");
}
				parseHabbo(collector);
				parseSettings(collector);
			}, function (): void {
				// Error.
CONFIG::debug
{
				Logging.debug("Client failed, probably not authenticated.");
}
			});
				
CONFIG::debug
{
			Logging.debug("Finished loading.");
}
        }
		
		private function parseClient(collector:Collector, callback:Function, error:Function): void
		{
			// Parse client.
			HTTP.fetchClientInfo(function (result:DataClient): void {
CONFIG::debug
{
				Logging.debug("Got sso " + result.sso);
}
				
				collector.setClient(result);
				callback();
			}, function (): void {
				// Error.
				collector.setClient(null);
				error();
			});
		}
		
		private function parseHabbo(collector:Collector): void
		{
			// Parse habbo.
			HTTP.fetchHabbo(function (result:DataHabbo): void {
CONFIG::debug
{
				Logging.debug("Got username " + result.username);
				Logging.debug("Got look " + result.look);
				Logging.debug("Got credits " + result.credits);
				Logging.debug("Got duckets " + result.duckets);
				Logging.debug("Got diamonds " + result.diamonds);
				Logging.debug("Got belcredits " + result.belcredits);
}
				
				collector.setHabbo(result);
			}, function (): void {
				// Error.
				collector.setHabbo(null);
			});
		}
		
		private function parseSettings(collector:Collector): void
		{
			// Parse account settings.
			HTTP.fetchSettings(function (result:DataSettings): void {
CONFIG::debug
{
				Logging.debug("Got email " + result.email);
}
				
				collector.setSettings(result);
			}, function (): void {
				// Error.
				collector.setSettings(null);
			});
		}
	}

}